# Test Design: Story E3.S11

Date: 2025-09-29
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 8
- Unit tests: 4 (50%)
- Integration tests: 2 (25%)
- E2E tests: 2 (25%)
- Priority distribution: P0: 4, P1: 3, P2: 1

## Background and Scope

实现 QA 扩展消息增强功能，为 MCP 自动化提供可编排的 QA 指令。包括 background 层新增 QA 消息类型、内容脚本 QA Bridge 更新、MCP 批处理集成，以及 Service Worker 重启控制。测试覆盖 QA handler 分支、消息传递机制、MCP 集成流程。

## Test Scenarios by Acceptance Criteria

### AC1: Background 层新增 QA 消息类型

| ID              | Level | Priority | Test 描述                                             | Justification                                             | Mitigates |
|-----------------|-------|----------|------------------------------------------------------|-----------------------------------------------------------|-----------|
| E3.S11-UNIT-001 | unit  | P0       | 验证 QA_APPLY_TERM 消息处理逻辑                       | 纯函数逻辑，单元测试可控                                  | TECH-001 |
| E3.S11-UNIT-002 | unit  | P0       | 验证 QA_REMOVE_TERM 消息处理逻辑                     | 同上，核心业务逻辑                                        | TECH-001 |
| E3.S11-UNIT-003 | unit  | P0       | 验证 QA_QUERY_TERM 消息处理逻辑                       | 同上，状态查询逻辑                                        | TECH-002 |
| E3.S11-UNIT-004 | unit  | P0       | 验证 QA_RESET_WORKER 消息处理逻辑                     | 同上，Service Worker 控制                                | TECH-003 |

### AC2: 内容脚本 QA Bridge 更新

| ID              | Level | Priority | Test 描述                                             | Justification                                             | Mitigates |
|-----------------|-------|----------|------------------------------------------------------|-----------------------------------------------------------|-----------|
| E3.S11-INT-001  | int   | P1       | 验证 window.__miniTranslateQA API 暴露与消息传递      | 涉及 content script 与 background 通信，需集成测试        | TECH-002 |
| E3.S11-INT-002  | int   | P1       | 验证 tabId 解析与错误处理机制                         | 跨组件协作，需要集成验证                                  | TECH-004 |

### AC3: MCP 批处理集成

| ID              | Level | Priority | Test 描述                                             | Justification                                             | Mitigates |
|-----------------|-------|----------|------------------------------------------------------|-----------------------------------------------------------|-----------|
| E3.S11-E2E-001  | e2e   | P1       | 验证 MCP 自动化完整流程：翻译写入→回退→重启→复检      | 端到端用户场景，验证完整工作流                            | OPS-001   |
| E3.S11-E2E-002  | e2e   | P2       | 验证 Example Domain 页面翻译断言与状态持久性         | 特定场景验证，确保自动化稳定性                            | OPS-002   |

## Risk Coverage

- TECH-001: E3.S11-UNIT-001, E3.S11-UNIT-002 (消息处理逻辑)
- TECH-002: E3.S11-UNIT-003, E3.S11-INT-001 (状态查询与 API 暴露)
- TECH-003: E3.S11-UNIT-004 (Service Worker 控制)
- TECH-004: E3.S11-INT-002 (错误处理)
- OPS-001: E3.S11-E2E-001 (MCP 自动化流程)
- OPS-002: E3.S11-E2E-002 (特定场景验证)

## Test Data Requirements

### Unit Tests
- Mock chrome.runtime API
- Mock chrome.storage.local
- Mock chrome.tabs API
- 测试数据：词条、翻译、tabId、错误场景

### Integration Tests
- 真实 Chrome 扩展环境
- 多 tab 场景测试
- 消息传递验证

### E2E Tests
- MCP 批处理环境
- Example Domain 页面
- Service Worker 重启验证

## Recommended Execution Order

1. P0 单元测试（E3.S11-UNIT-001/002/003/004）
2. P1 集成测试（E3.S11-INT-001/002）
3. P1 端到端测试（E3.S11-E2E-001）
4. P2 特定场景测试（E3.S11-E2E-002）

## Test Environment Requirements

- Chrome 扩展开发环境
- MCP 自动化测试环境
- Example Domain 测试页面
- QA build 配置（MT_QA_HOOKS=true）

## Success Criteria

- 所有 P0 测试通过
- MCP 自动化流程稳定执行
- QA Hook 仅在 QA build 中注册
- 文档更新完整

Test design matrix: docs/qa/assessments/e3.s11-test-design-20250929.md
P0 tests identified: 4
